<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CROSS PLAY STORE</title>
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      /* إضافة أنماط جديدة */
      .user-info {
        display: flex;
        align-items: center;
        margin-right: 10px;
      }
      .user-info span {
        margin-right: 5px;
        font-size: 14px;
      }
      .cart-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background-color: red;
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 12px;
      }
      .cart-icon {
        position: relative;
      }
      .welcome-message {
        margin-top: 20px;
        text-align: center;
        font-size: 18px;
        color: #333;
      }
    </style>
  </head>
  <body>
    <!-- شريط علوي -->
    <header class="header">
      <div class="header-content">
        <div class="logo-text">
          <h1>CROSS PLAY STORE</h1>
          <p>كل شيء في مكان واحد</p>
        </div>
        <div class="header-icons">
          <div class="cart-icon" onclick="window.location.href='cart.html';">
            <i class="fas fa-shopping-cart"></i>
            <span class="cart-badge" id="cart-count">0</span>
          </div>
          <div class="menu-toggle" onclick="toggleMenu()">
            <i class="fas fa-bars"></i>
            <div class="dropdown-menu" id="dropdown">
              <!-- سيتم تحديث هذه القائمة ديناميكيًا بناءً على حالة تسجيل الدخول -->
              <a href="login.html">تسجيل دخول</a>
              <a href="signup.html">إنشاء حساب</a>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- صور متحركة -->
    <section class="slideshow">
      <img id="slideshow-img" src="imgs/1.jpg" alt="صورة متحركة" />
    </section>

    <!-- رسالة ترحيب -->
    <div class="welcome-message" id="welcome-message">
      مرحبًا بك في متجر CROSS PLAY STORE
    </div>

    <!-- الأقسام (الفئات) -->
    <main class="categories" id="categories">
      <!-- سيتم توليد الفئات والمنتجات ديناميكيًا من Firebase -->
    </main>

    <footer>
      <p id="support-number">رقم الدعم الفني: 9200XXXX</p>
      <a href="policy.html">سياسة المتجر</a>
    </footer>

    <!-- إضافة مكتبات Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <script>
      // تكوين Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyBRgEBLW3uSL6nrQNoMPwhM6yKFrNzThj4",
        authDomain: "crossplay-store.firebaseapp.com",
        databaseURL: "https://crossplay-store-default-rtdb.firebaseio.com",
        projectId: "crossplay-store",
        storageBucket: "crossplay-store.appspot.com",
        messagingSenderId: "918790495368",
        appId: "1:918790495368:web:830e3a8c399c9e62c3d33d"
      };

      // تهيئة Firebase
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
      const storage = firebase.storage();
      
      // التحقق من حالة المصادقة
      auth.onAuthStateChanged(user => {
        if (user) {
          console.log("تم تسجيل الدخول:", user.email);
          // تحديث واجهة المستخدم عند تسجيل الدخول
          updateUIOnLogin(user);
        } else {
          console.log("لم يتم تسجيل الدخول");
          // تحديث واجهة المستخدم عند تسجيل الخروج
          updateUIOnLogout();
        }
      });
      
      // تحديث واجهة المستخدم عند تسجيل الدخول
      function updateUIOnLogin(user) {
        // تحديث رسالة الترحيب
        const welcomeMessage = document.getElementById('welcome-message');
        welcomeMessage.textContent = `مرحبًا بك ${user.displayName || 'عزيزي المستخدم'} في متجر CROSS PLAY STORE`;
        
        // تحديث القائمة المنسدلة
        const dropdownMenu = document.getElementById('dropdown');
        dropdownMenu.innerHTML = `
          <a href="profile.html">الملف الشخصي</a>
          <a href="orders.html">طلباتي</a>
          <a href="#" onclick="logout()">تسجيل خروج</a>
        `;
        
        // التحقق مما إذا كان المستخدم مديرًا
        checkIfAdmin(user.uid);
        
        // تحديث عدد العناصر في سلة التسوق
        updateCartCount(user.uid);
      }
      
      // تحديث واجهة المستخدم عند تسجيل الخروج
      function updateUIOnLogout() {
        // تحديث رسالة الترحيب
        const welcomeMessage = document.getElementById('welcome-message');
        welcomeMessage.textContent = 'مرحبًا بك في متجر CROSS PLAY STORE';
        
        // تحديث القائمة المنسدلة
        const dropdownMenu = document.getElementById('dropdown');
        dropdownMenu.innerHTML = `
          <a href="login.html">تسجيل دخول</a>
          <a href="signup.html">إنشاء حساب</a>
        `;
        
        // تصفير عدد العناصر في سلة التسوق
        document.getElementById('cart-count').textContent = '0';
      }
      
      // التحقق مما إذا كان المستخدم مديرًا
      async function checkIfAdmin(userId) {
        try {
          const userDoc = await db.collection('users').doc(userId).get();
          if (userDoc.exists && userDoc.data().isAdmin) {
            // إضافة رابط لوحة التحكم للمدير
            const dropdownMenu = document.getElementById('dropdown');
            const firstChild = dropdownMenu.firstChild;
            const adminLink = document.createElement('a');
            adminLink.href = 'admin.html';
            adminLink.textContent = 'لوحة التحكم';
            dropdownMenu.insertBefore(adminLink, firstChild);
          }
        } catch (error) {
          console.error("خطأ في التحقق من صلاحيات المدير:", error);
        }
      }
      
      // تحديث عدد العناصر في سلة التسوق
      async function updateCartCount(userId) {
        try {
          const cartSnapshot = await db.collection('cart').where('userId', '==', userId).get();
          document.getElementById('cart-count').textContent = cartSnapshot.size;
        } catch (error) {
          console.error("خطأ في تحديث عدد عناصر السلة:", error);
        }
      }
      
      // تسجيل الخروج
      async function logout() {
        try {
          await auth.signOut();
          window.location.reload();
        } catch (error) {
          console.error("خطأ في تسجيل الخروج:", error);
          alert("حدث خطأ أثناء تسجيل الخروج");
        }
      }
      
      // إظهار/إخفاء القائمة المنسدلة
      function toggleMenu() {
        document.getElementById("dropdown").classList.toggle("show");
      }
      
      // إغلاق القائمة المنسدلة عند النقر خارجها
      window.onclick = function(event) {
        if (!event.target.matches('.menu-toggle') && !event.target.matches('.menu-toggle i')) {
          const dropdown = document.getElementById("dropdown");
          if (dropdown.classList.contains('show')) {
            dropdown.classList.remove('show');
          }
        }
      }
      
      // تحميل الفئات والمنتجات
      async function loadCategories() {
        try {
          const categoriesSnapshot = await db.collection('categories').orderBy('order').get();
          const categoriesContainer = document.getElementById('categories');
          categoriesContainer.innerHTML = '';
          
          if (categoriesSnapshot.empty) {
            // إذا لم تكن هناك فئات، عرض رسالة
            categoriesContainer.innerHTML = '<p class="no-data">لا توجد منتجات متاحة حاليًا</p>';
            return;
          }
          
          // إنشاء عنصر لكل فئة
          for (const categoryDoc of categoriesSnapshot.docs) {
            const category = categoryDoc.data();
            const categoryElement = document.createElement('div');
            categoryElement.className = 'category';
            categoryElement.innerHTML = `
              <h2 class="category-title">${category.name}</h2>
              <div class="products" id="products-${categoryDoc.id}"></div>
            `;
            categoriesContainer.appendChild(categoryElement);
            
            // تحميل منتجات الفئة
            loadProducts(categoryDoc.id);
          }
        } catch (error) {
          console.error("خطأ في تحميل الفئات:", error);
        }
      }
      
      // تحميل منتجات فئة معينة
      async function loadProducts(categoryId) {
        try {
          const productsSnapshot = await db.collection('products')
            .where('categoryId', '==', categoryId)
            .where('active', '==', true)
            .get();
          
          const productsContainer = document.getElementById(`products-${categoryId}`);
          
          if (productsSnapshot.empty) {
            productsContainer.innerHTML = '<p class="no-products">لا توجد منتجات في هذه الفئة</p>';
            return;
          }
          
          // إنشاء عنصر لكل منتج
          for (const productDoc of productsSnapshot.docs) {
            const product = productDoc.data();
            const productElement = document.createElement('div');
            productElement.className = 'product';
            productElement.onclick = () => window.location.href = `product.html?id=${productDoc.id}`;
            
            // استخدام صورة افتراضية إذا لم تكن هناك صورة للمنتج
            const imageUrl = product.imageUrl || 'imgs/placeholder.jpg';
            
            productElement.innerHTML = `
              <img src="${imageUrl}" alt="${product.name}">
              <div class="product-info">
                <h3 class="product-title">${product.name}</h3>
                <p class="product-price">${product.price} ريال</p>
              </div>
            `;
            
            productsContainer.appendChild(productElement);
          }
        } catch (error) {
          console.error(`خطأ في تحميل منتجات الفئة ${categoryId}:`, error);
        }
      }
      
      // تحميل الصور المتحركة
      let slideIndex = 0;
      const slides = ['imgs/1.jpg', 'imgs/2.jpg', 'imgs/3.jpg'];
      
      function showSlides() {
        const slideshowImg = document.getElementById('slideshow-img');
        slideIndex = (slideIndex + 1) % slides.length;
        slideshowImg.src = slides[slideIndex];
        setTimeout(showSlides, 3000); // تغيير الصورة كل 3 ثوانٍ
      }
      
      // بدء عرض الصور المتحركة وتحميل الفئات عند تحميل الصفحة
      window.onload = function() {
        showSlides();
        loadCategories();
      };
    </script>
  </body>
</html>

